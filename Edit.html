<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BINGO Edit</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .main-container{
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .container {
            position: relative;
            width: 1000px; /* 画像の幅 */
            height: 500px; /* 画像の高さ */
            margin: 0 20px;
        }

        .container img {
            display: block;
            width: 400px;
            height: 500px;
        }

        .square-textbox {
            position: absolute;
            width: 55px; /* 画像サイズに応じた幅 */
            height: 55px; /* 画像サイズに応じた高さ */
            resize: none;
            box-sizing: border-box;
            font-size: 36px;
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid #000;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            overflow: hidden; /* 改行を防ぐ */
            white-space: nowrap; /* 改行を防ぐ */
            line-height: 1; /* 行の高さを調整して改行を防ぐ */
        }
        
        .arrow-button {
            font-size: 20px;
            background-color: rgb(200, 200, 200);
            border: 1px solid #000;
            cursor: pointer;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
        }
        #leftArrow {
            left: 0;

        }

        #rightArrow {
            left: 400px;

        }
        .input-form {
            position: absolute;

        margin-top: 20px; /* Adjust as needed */
        left: 600px;
        top:300px
        }

        .input-number {
            width: 200px; /* Adjust width as needed */
            padding: 5px;
            margin-bottom: 10px; /* Adjust spacing between inputs */
            font-size: 16px; /* Adjust font size */
    
        
        }

        .input-submit {
            padding: 8px 15px;
            background-color: #007bff;
            color: #fff;
            border: none;
            cursor: pointer;
            font-size: 16px; /* Adjust font size */
        }

        .input-output {
            margin-top: 10px; /* Adjust margin as needed */
            font-size: 14px; /* Adjust font size */
        }

        /* テキストボックスの配置（画像のピクセル座標で指定） */

        
        .textbox-1 { top:  177.5px;  left: 77.5px; } /* 画像の高さの30.5% + 20px、幅の13.5% + 10px */
        .textbox-2 { top: 177.5px; left: calc(77.5px + 67.5px); } /* 画像の高さの30.5% + 20px、幅の25% + 10px */
        .textbox-3 { top:  177.5px; left: calc(77.5px + (67.5px * 2)); } /* 画像の高さの30.5% + 20px、幅の36.5% + 10px */
        .textbox-4 { top:  177.5px;  left: calc(77.5px + (67.5px * 3)); } /* 画像の高さの30.5% + 20px、幅の48% + 10px */
        .textbox-5 { top:  177.5px;  left: calc(77.5px + (67.5px * 4)); } /* 画像の高さの30.5% + 20px、幅の59.5% + 10px */

        .textbox-6 { top: 245.5px; left: 77.5px; } /* 画像の高さの42% + 20px、幅の13.5% + 10px */
        .textbox-7 { top: 245.5px;left: calc(77.5px + 67.5px); } /* 画像の高さの42% + 20px、幅の25% + 10px */
        .textbox-8 { top:245.5px; left: calc(77.5px + (67.5px * 2)); } /* 画像の高さの42% + 20px、幅の36.5% + 10px */
        .textbox-9 { top: 245.5px; left: calc(77.5px + (67.5px * 3)); } /* 画像の高さの42% + 20px、幅の48% + 10px */
        .textbox-10 { top: 245.5px; left: calc(77.5px + (67.5px * 4)); } /* 画像の高さの42% + 20px、幅の59.5% + 10px */
        .textbox-11 { top: 313.5px; left: 77.5px; } /* 画像の高さの53.5% + 20px、幅の13.5% + 10px */
        .textbox-12 { top: 313.5px; left: calc(77.5px + 67.5px); } /* 画像の高さの53.5% + 20px、幅の25% + 10px */
        .textbox-13 { top: 313.5px; left: calc(77.5px + (67.5px * 2)); display: none; } /* 中央のテキストボックスを非表示にする */
        .textbox-14 { top: 313.5px; left: calc(77.5px + (67.5px * 3)); } /* 画像の高さの53.5% + 20px、幅の48% + 10px */
        .textbox-15 { top: 313.5px; left: calc(77.5px + (67.5px * 4)); } /* 画像の高さの53.5% + 20px、幅の59.5% + 10px */

        .textbox-16 { top: 381.5px; left: 77.5px; } /* 画像の高さの65% + 20px、幅の13.5% + 10px */
        .textbox-17 { top: 381.5px; left: calc(77.5px + 67.5px); } /* 画像の高さの65% + 20px、幅の25% + 10px */
        .textbox-18 { top: 381.5px; left: calc(77.5px + (67.5px * 2)); } /* 画像の高さの65% + 20px、幅の36.5% + 10px */
        .textbox-19 { top: 381.5px; left: calc(77.5px + (67.5px * 3)); } /* 画像の高さの65% + 20px、幅の48% + 10px */
        .textbox-20 { top: 381.5px; left: calc(77.5px + (67.5px * 4)); } /* 画像の高さの65% + 20px、幅の59.5% + 10px */

        .textbox-21 { top: 445.5px; left: 77.5px; } /* 画像の高さの76.5% + 20px、幅の13.5% + 10px */
        .textbox-22 { top:445.5px; left: calc(77.5px + 67.5px); } /* 画像の高さの76.5% + 20px、幅の25% + 10px */
        .textbox-23 { top: 445.5px; left: calc(77.5px + (67.5px * 2)); } /* 画像の高さの76.5% + 20px、幅の36.5% + 10px */
        .textbox-24 { top: 445.5px; left: calc(77.5px + (67.5px * 3)); } /* 画像の高さの76.5% + 20px、幅の48% + 10px */
        .textbox-25 { top: 445.5px; left: calc(77.5px + (67.5px * 4)); } /* 画像の高さの76.5% + 20px、幅の59.5% + 10px */
        .form-container{
            margin: 0 20px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
    </style>
</head>
<body class="input">
    <main>
        <div class="main-container">
            <div class="form-container">
                <button class="back-button" onclick="location.href='./Title.html'">タイトルに戻る</button>
                <button class="home-button" onclick="location.href='./Home.html'">ホームに戻る</button>
                <button class="card-button" onclick="location.href='./Select.html'">カード選択に戻る</button>
            </div>
            <div class="container">
                <button class="arrow-button" id="leftArrow" >←</button>
                <img src="picture/BINGOcard.JPG" alt="BINGO Card">
                <input class="square-textbox textbox-1" type="number" id="numeric1"></input>
                <input class="square-textbox textbox-2" type="number" id="numeric2"></input>
                <input class="square-textbox textbox-3" type="number" id="numeric3"></input>
                <input class="square-textbox textbox-4" type="number" id="numeric4"></input>
                <input class="square-textbox textbox-5" type="number" id="numeric5"></input>
                <input class="square-textbox textbox-6" type="number" id="numeric6"></input>
                <input class="square-textbox textbox-7" type="number" id="numeric7"></input>
                <input class="square-textbox textbox-8" type="number" id="numeric8"></input>
                <input class="square-textbox textbox-9" type="number" id="numeric9"></input>
                <input class="square-textbox textbox-10" type="number" id="numeric10"></input>
                <input class="square-textbox textbox-11" type="number" id="numeric11"></input>
                <input class="square-textbox textbox-12" type="number" id="numeric12"></input>
                <input class="square-textbox textbox-13" type="number" id="numeric13"></input>
                <input class="square-textbox textbox-14" type="number" id="numeric14"></input>
                <input class="square-textbox textbox-15" type="number" id="numeric15"></input>
                <input class="square-textbox textbox-16" type="number" id="numeric16"></input>
                <input class="square-textbox textbox-17" type="number" id="numeric17"></input>
                <input class="square-textbox textbox-18" type="number" id="numeric18"></input>
                <input class="square-textbox textbox-19" type="number" id="numeric19"></input>
                <input class="square-textbox textbox-20" type="number" id="numeric20"></input>
                <input class="square-textbox textbox-21" type="number" id="numeric21"></input>
                <input class="square-textbox textbox-22" type="number" id="numeric22"></input>
                <input class="square-textbox textbox-23" type="number" id="numeric23"></input>
                <input class="square-textbox textbox-24" type="number" id="numeric24"></input>
                <input class="square-textbox textbox-25" type="number" id="numeric25"></input>
                <button id="rightArrow" class="arrow-button" >→</button>
                <form class="input-form" onsubmit="return handleFormSubmit(event)">
                    <span id="pageInfo"></span> <!-- 現在のページ数を表示する部分 -->
                    <button class="register-button" id="registerButton">更新</button> <!-- 更新ボタンに変更 -->
                </form>
                
                
            </div>
        </div>
    </main>
    <button class="back-button" onclick="location.href='./Title.html'">タイトルに戻る</button>
    <button class="home-button" onclick="location.href='./Home.html'">ホームに戻る</button>

    <script>
        document.querySelectorAll('.square-textbox').forEach((textbox, index, textboxes) => {
            textbox.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (textboxes[index].value.length > 2) {
                        textboxes[index].value = textboxes[index].value.slice(0, 2);
                    }
                    let nextTextbox = textboxes[index + 1];
                    if (index === 11) {
                        nextTextbox = textboxes[index + 2];
                    }
                    if (nextTextbox) {
                        nextTextbox.focus();
                    }
                }
            });
        });
    </script>
    <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore-compat.js"></script>    
    <script>
        //firebaseのAPIキー(最初に書くのが望ましい)
        firebase.initializeApp({
            apiKey: "AIzaSyBFglLx2pDfHSpyEUUpn0c939BWS1vmzQg",
            projectId: "bingoapp-8c5c0",
        });


        // グローバル変数群
        let allValues = {};//firebaseから持ってきた配列をまとめて格納している
        let currentValuesIndex = 1;//現在カードが何枚目かのカウント変数
        let maxValuesIndex = 1; //valuesいくらまであるかの変数
        let storedDocID = null; //ひとつ前の画面から持ってきたドキュメントID
        const db = firebase.firestore();


       
        /* 
        allValuesについて

            ex)　values1の内容の取り出し
                  　const values1Contents = allValues['values1'];

            ex) 　現在表示しているカードでの処理
                    const valuesIndex = `values${currentValuesIndex}`;
                    const valuesContents = allValues[valuesIndex];


             連想配列で定義しているのでこんな感じで取り出してね。

        */


        //document.addEventListener->画面が起動したら動く関数
        document.addEventListener('DOMContentLoaded', function() {
            // ローカルストレージからドキュメントIDを取得してグローバル変数に格納
            storedDocID = localStorage.getItem('selectedBingoCardId');
            if (storedDocID) {
                fetchFirestoreData(storedDocID).then(() => {
                    updatePageInfo();
                });
            } else {
                alert(`Document IDが読み込めていません`);
            }
        });

        // Firestoreからデータを取得する関数
        function fetchFirestoreData(storedDocID) {
            return db.collection('BINGOApp').doc(storedDocID).get().then((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    console.log("data"+data);
                    // values1, values2, values3, ... というプロパティを持つデータを取得してallValuesに格納
                    while (data.hasOwnProperty(`values${maxValuesIndex}`)) {
                        allValues[`values${maxValuesIndex}`] = data[`values${maxValuesIndex}`];
                        maxValuesIndex++;
                    }
                    // console.log( "allValues"+allValues);
                    maxValuesIndex-=1;
                    // currentValuesIndexが上限を超えないように調整
                    if (currentValuesIndex > maxValuesIndex) {
                        currentValuesIndex = maxValuesIndex;
                    }


                    console.log(allValues); // 確認用：allValuesの内容をコンソールに出力

                    // テキストボックスに値を設定する
                    const textboxes = document.querySelectorAll('.square-textbox');
                    textboxes.forEach((textbox, index) => {
                        textbox.value = allValues['values1'][index] || ''; // 空文字列でない場合のみ設定
                    });
                } else {
                    console.error('No such document!');
                }
            }).catch((error) => {
                console.error('Error getting document:', error);
            });
        }


        // allValuesを更新する関数
        function updateAllValues() {
            return new Promise((resolve, reject) => {
                const textboxes = document.querySelectorAll('.square-textbox');
                let values = [];
                textboxes.forEach(textbox => {
                    values.push(textbox.value);
                });

                // BINGOカードが何枚目かを見てフィールド名を決める。(values1,2,3....)
                const valuesIndex = `values${currentValuesIndex}`;

                // allValuesの該当部分を上書き
                allValues[valuesIndex] = values;

                // ログで確認
                console.log(`Updated ${valuesIndex} in allValues:`, allValues[valuesIndex]);
                
                resolve();
            });
        }


        // Firestoreからデータを取得して初期テキストボックスの値を設定する関数
        function updateTextBoxValues() {
            // BINGOカードが何枚目かを見てフィールド名を決める。(values1,2,3....)
            const valuesIndex = `values${currentValuesIndex}`;

            // allValuesから現在のページのvaluesを取得
            const valuesContents = allValues[valuesIndex];

            if (!valuesContents) {
                console.error(`No data found for ${valuesIndex}`);
                return;
            }

            // テキストボックスに値を設定する
            const textboxes = document.querySelectorAll('.square-textbox');
            textboxes.forEach((textbox, index) => {
                textbox.value = valuesContents[index] || ''; // 空文字列でない場合のみ設定
            });
        }


        function save() {
            const currentIndex = currentValuesIndex; // ローカル変数として現在のインデックスを固定化する

            const textboxes = document.querySelectorAll('.square-textbox');
            let values = [];
            textboxes.forEach(textbox => {
                values.push(textbox.value);
            });

            const fieldName = `values${currentIndex}`;

            const updateObject = {};
            updateObject[fieldName] = values;

            db.collection('BINGOApp').doc(storedDocID).update(updateObject)
                .then(function() {
                    console.log('Document updated successfully.');
                    // alert(currentIndex + "枚目を更新3"); // ローカル変数 currentIndex を利用する
                }).catch(function(error) {
                    console.error('Error updating document:', error);
                });
        }


        // 現在のページ数を表示する関数
        function updatePageInfo() {
            
            const pageInfo = document.getElementById('pageInfo');
            pageInfo.textContent = `${currentValuesIndex}/${maxValuesIndex} 枚中`;
        }




        // 右矢印の処理
        document.querySelector('#rightArrow').addEventListener('click', function() {
            event.preventDefault(); // 関数実行後にリロードするsubmitボタンのデフォルト機能を止める。

            // BINGOカードが最後なら右に進めない処理
            if (currentValuesIndex < maxValuesIndex) {
                save();
                updateAllValues()
                currentValuesIndex++;
                updateTextBoxValues();
                updatePageInfo();

            }
        });

        // 左矢印の処理
        document.querySelector('#leftArrow').addEventListener('click', function() {
            event.preventDefault(); // 関数実行後にリロードするsubmitボタンのデフォルト機能を止める。

            // BINGOカードが一枚目なら左に進めない処理
            if (currentValuesIndex > 1) {
                save();
                updateAllValues()
                currentValuesIndex--;
                updateTextBoxValues();
                updatePageInfo();

            }
        });

        //更新ボタンの処理
        document.querySelector('#registerButton').addEventListener('click', function(event) {
            event.preventDefault(); // 関数実行後にリロードするsubmitボタンのデフォルト機能を止める。
            //保存のみ
            save();//firestoreに更新する
            updateAllValues();//firestoreに更新を掛けたのでallValuesにも更新をかける
        });
    </script> 
</body>
</html>

